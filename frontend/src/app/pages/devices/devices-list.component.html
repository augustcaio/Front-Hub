<div class="p-4 max-w-[1400px] mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="m-0 mb-2 text-3xl font-semibold text-[var(--text-color)]">Dispositivos</h1>
    <p class="m-0 text-[var(--text-color-secondary)]">Gerencie seus dispositivos IoT</p>
  </div>

  <!-- Toolbar com Filtros -->
  <p-card class="mb-4">
    <p-toolbar>
      <div class="p-toolbar-group-start flex flex-wrap items-center gap-4 w-full md:w-auto">
        <!-- Search Input -->
        <span class="p-input-icon-left flex-1 md:flex-none min-w-[200px]">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            [(ngModel)]="searchText"
            (input)="onSearch()"
            placeholder="Buscar por nome, ID ou descrição..."
            class="w-full"
          />
        </span>

        <!-- Status Filter -->
        <p-dropdown
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          (onChange)="onStatusChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Filtrar por status"
          [style]="{ width: '200px' }"
          [showClear]="true">
        </p-dropdown>

        <!-- Clear Search Button -->
        <p-button
          *ngIf="searchText || selectedStatus"
          label="Limpar Filtros"
          icon="pi pi-times"
          [styleClass]="'p-button-outlined'"
          (click)="selectedStatus = null; clearSearch()">
        </p-button>
      </div>

      <div class="p-toolbar-group-end flex gap-2">
        <p-button
          label="Novo Dispositivo"
          icon="pi pi-plus"
          [styleClass]="'p-button-primary'"
          routerLink="/devices/new">
        </p-button>
        <p-button
          label="Atualizar"
          icon="pi pi-refresh"
          [styleClass]="'p-button-outlined'"
          [loading]="loading"
          (click)="refresh()">
        </p-button>
      </div>
    </p-toolbar>
  </p-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex flex-col items-center justify-center p-12 text-center">
    <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
    <p class="mt-4 text-[var(--text-color-secondary)]">Carregando dispositivos...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="mb-4">
    <p-card>
      <div class="flex flex-col items-center gap-4 p-4">
        <i class="pi pi-exclamation-triangle text-5xl text-red-500"></i>
        <p class="m-0 text-[var(--text-color)]">{{ error }}</p>
        <p-button
          label="Tentar novamente"
          icon="pi pi-refresh"
          (click)="refresh()"
          [styleClass]="'p-button-outlined'">
        </p-button>
      </div>
    </p-card>
  </div>

  <!-- Devices Table -->
  <div *ngIf="!loading && !error">
    <!-- Empty State -->
    <div *ngIf="devices.length === 0" class="mt-4">
      <p-card>
        <div class="flex flex-col items-center gap-4 p-8 text-center">
          <i class="pi pi-inbox text-6xl text-[var(--text-color-secondary)]"></i>
          <p class="m-0 text-[var(--text-color-secondary)]">
            <span *ngIf="searchText || selectedStatus">Nenhum dispositivo encontrado com os filtros aplicados.</span>
            <span *ngIf="!searchText && !selectedStatus">Nenhum dispositivo cadastrado.</span>
          </p>
          <p-button
            *ngIf="searchText || selectedStatus"
            label="Limpar Filtros"
            icon="pi pi-times"
            (click)="selectedStatus = null; clearSearch()">
          </p-button>
        </div>
      </p-card>
    </div>

    <!-- Table -->
    <p-card *ngIf="devices.length > 0">
      <p-table
        [value]="devices"
        [paginator]="true"
        [rows]="rows"
        [first]="first"
        [totalRecords]="totalRecords"
        [lazy]="false"
        [loading]="loading"
        (onPage)="onPageChange($event)"
        [rowsPerPageOptions]="[10, 20, 50]"
        responsiveLayout="scroll"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} dispositivos"
        styleClass="p-datatable-sm">
        
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name">Nome <p-sortIcon field="name"></p-sortIcon></th>
            <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon></th>
            <th>ID Público</th>
            <th>Descrição</th>
            <th pSortableColumn="created_at">Criado em <p-sortIcon field="created_at"></p-sortIcon></th>
            <th style="width: 10rem">Ações</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-device>
          <tr>
            <td>
              <span class="font-semibold text-[var(--text-color)]">{{ device.name }}</span>
            </td>
            <td>
              <p-tag
                [value]="getStatusLabel(device.status)"
                [severity]="getStatusSeverity(device.status)">
              </p-tag>
            </td>
            <td>
              <span class="text-xs text-[var(--text-color-secondary)] font-mono">
                {{ device.public_id }}
              </span>
            </td>
            <td>
              <span *ngIf="device.description" class="text-[var(--text-color-secondary)]">
                {{ device.description.length > 50 ? (device.description | slice:0:50) + '...' : device.description }}
              </span>
              <span *ngIf="!device.description" class="text-[var(--text-color-secondary)] italic">
                Sem descrição
              </span>
            </td>
            <td>
              <span class="text-[var(--text-color-secondary)]">
                {{ formatDate(device.created_at) }}
              </span>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button
                  label="Detalhes"
                  icon="pi pi-eye"
                  [styleClass]="'p-button-outlined p-button-sm'"
                  [routerLink]="['/devices', device.id]">
                </p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center p-8">
              <div class="flex flex-col items-center gap-4">
                <i class="pi pi-inbox text-4xl text-[var(--text-color-secondary)]"></i>
                <p class="text-[var(--text-color-secondary)]">Nenhum dispositivo encontrado</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div>
